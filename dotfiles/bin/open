#!/usr/bin/env zsh
RE_MATCH_PCRE=1

F="$1"

if [ -e "$F" ]; then
    mime="$(file --mime-type --brief $F)"
    exists=1
fi

echo $mime

while read mode match; do
    case $mode in
        exec)
            if [ ! -z $found ]
            then
                command=( ${(s. .)match} $F )
                exec $command
            fi
        ;;
        re)
            if [[ -n $exists && "$F" =~ "$match" ]]
            then
                found=1
            fi
        ;;
        mime)
            if [[ -n $exists && "$mime" =~ "$match"  ]]; then
                found=1
            fi
            ;;
        scheme*)
            if [ $mode = scheme ]; then
                match="^$match:.*"
            fi
            if [[ -z $exists && "$F" =~ "$match" ]]; then
                found=1
            fi
            ;;
    esac
done < $HOME/.config/open-rules
