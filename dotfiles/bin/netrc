#!/usr/bin/env nix-shell
#! nix-shell -i python -p python

import sys,os

def chomp(words):
    this_machine = None
    key_word = None
    attributes = {}
    for word in words:
        if word == "machine":
            key_word = word
            if len(attributes):
                yield attributes
            attributes = {}
        elif key_word:
            attributes[key_word] = word
            key_word = None
        else:
            key_word = word
    if len(attributes):
        yield(attributes)

def match(query, machine):
    for key in query:
        if key in machine:
            if machine[key] != query[key]:
                return False
        else:
            return False
    return True

def main(args):
    # we do not support spaces in passwords
    queries = list(chomp(args[1:-1]))
    matches = []
    with open(os.path.expanduser("~/.netrc")) as netrc:
        words = netrc.read().split()
        for attributes in chomp(words):
            for query in queries:
                if match(query, attributes):
                    matches.append(attributes)

    if len(matches) == 1:
        the_match = matches[0]
        key = args[-1]
        if key in the_match:
            print(the_match[key])
        else:
            print(str(the_match) + ' has no ' + key)
    elif len(matches) > 0:
        print('excess matches:')
        for m in matches:
            print(m)
        sys.exit(1)
    else:
        print('no matches')
        sys.exit(1)

if __name__ == "__main__":
    main(sys.argv)
