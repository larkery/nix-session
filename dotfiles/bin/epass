#!/usr/bin/env nix-shell
#!nix-shell -i zsh -p zsh jq dmenu xdotool

FLATTEN='def flat: if .contents then (.name as $p | .contents[] | flat | (.name = $p + "/" + .name)) else . end;'

load() {
    for fn in ~/.passwords/*.json.gpg; do
        gpg2 --no-tty -d $fn 2>/dev/null
    done | jq -c -r "$FLATTEN"'flat | select('$1')'
}

setopt pipefail

choose() {
    LINE=$(echo -E "$1" | jq -r -c .name | dmenu -i -1 -p "$2: " -l 10)
    if [ ! -z "$LINE" ]; then
        echo -E "$1" | sed "${LINE}q;d"
    else
        return 1
    fi
}

case $1 in
    cat)
        load $2
        ;;
    type-user)
        choose "$(load .username)" "$1" | jq -r .username | xdotool type --clearmodifiers --file -
        ;;
    type-password)
        choose "$(load .password)" "$1" | jq -r .password | xdotool type --clearmodifiers --file -
        ;;
    type-login)
        DATA=$(choose "$(load '.username and .password')" "$1")
        echo "$DATA" | jq -r .username | xdotool type --clearmodifiers --file -
        xdotool type --clearmodifiers "	"
        echo "$DATA" | jq -r .password | xdotool type --clearmodifiers --file -
        ;;
    browse-url)
        U=$(choose "$(load .url)" "$1" | jq -r .url)
        [ ! -z "$U" ] && xdg-open "$U"
        ;;
    *)
        X=$(choose "$(load .)" "account: ")
        echo "$X" | jq -r 'keys(.)' | dmenu -1
esac
